import { redis } from '../../external-clients/redis.ts'
import { sessionId, acceptInvite } from '../app/accept-invite.tsx'
import { getInviteCode } from '../../db/models/health_workers.ts'
import {
    HealthWorkerWithGoogleTokens,
    LoggedInHealthWorkerHandler,
  } from '../../types.ts'

  type RedirectedAcceptInvitePageProps = {
    healthWorker: HealthWorkerWithGoogleTokens
  }

export const handler: LoggedInHealthWorkerHandler<RedirectedAcceptInvitePageProps> = {
    async GET(_req, ctx) {
        const healthWorker = ctx.state.session.data
        const inviteCodeFromSession = await redis.get(sessionId)
        if (inviteCodeFromSession) {
            const inviteCodeFromDB = await getInviteCode(ctx.state.trx, healthWorker.email)
            if (inviteCodeFromSession === inviteCodeFromDB) {
                acceptInvite()
            } else {
                throw new  Error("Invalid invite code.")
            }
        } else {
            throw new  Error("No invite code in session")
        }
        return ctx.render({ healthWorker })
    }
}